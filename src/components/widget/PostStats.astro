---
import WidgetLayout from "@components/sidebar/widgetLayout.astro";

interface Props {
  class?: string;
  style?: string;
  slug?: string;
}
const { class: className, style, slug } = Astro.props;
---

<WidgetLayout name="文章统计" id="post-stats" class:list={[className]} {style}>
    <div class="text-center py-2">
        <div class="text-3xl font-bold text-neutral-900 dark:text-neutral-100" id="post-pageviews">-</div>
        <div class="text-sm text-neutral-500 dark:text-neutral-400">浏览量</div>
    </div>
    <div class="grid grid-cols-2 divide-x divide-neutral-200 dark:divide-neutral-700 text-center pt-2">
        <div class="px-2">
            <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100" id="post-visits">-</div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">访问数</div>
        </div>
        <div class="px-2">
            <div class="text-xl font-bold text-neutral-900 dark:text-neutral-100" id="post-visitors">-</div>
            <div class="text-sm text-neutral-500 dark:text-neutral-400">访客数</div>
        </div>
    </div>
</WidgetLayout>

{slug && (
    <script define:vars={{ slug }}>
        const UMAMI_CONFIG = {
            baseUrl: 'https://cloud.umami.is/analytics/eu/api',
            websiteId: 'a5a99602-cf02-40c6-ac6a-bf29f897b738',
            shareToken: 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ3ZWJzaXRlSWQiOiJhNWE5OTYwMi1jZjAyLTQwYzYtYWM2YS1iZjI5Zjg5N2I3MzgiLCJpYXQiOjE3Njk1MDg1NDF9.aqwM_6v2noy-bkkIlHQdqCE_Mffe4srLyteS8ScQS2U'
        };

        function formatNumber(num: number): string {
            if (num >= 1000000) {
                return (num / 1000000).toFixed(1) + 'M';
            } else if (num >= 1000) {
                return (num / 1000).toFixed(1) + 'K';
            }
            return num.toString();
        }

        async function fetchPostStats() {
            try {
                const endAt = Date.now();
                const startAt = 0;
                // 构造文章页面的URL路径，使用 eq. 前缀进行精确匹配
                const pageUrl = `/posts/${slug}/`;
                const encodedPath = encodeURIComponent(`eq.${pageUrl}`);

                const url = `${UMAMI_CONFIG.baseUrl}/websites/${UMAMI_CONFIG.websiteId}/stats?startAt=${startAt}&endAt=${endAt}&unit=hour&timezone=Asia%2FShanghai&path=${encodedPath}`;

                const response = await fetch(url, {
                    method: 'GET',
                    headers: {
                        'accept': 'application/json',
                        'x-umami-share-token': UMAMI_CONFIG.shareToken
                    }
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const data = await response.json();
                const pageviewsElement = document.getElementById('post-pageviews');
                const visitsElement = document.getElementById('post-visits');
                const visitorsElement = document.getElementById('post-visitors');

                if (pageviewsElement) {
                    pageviewsElement.textContent = formatNumber(data.pageviews || 0);
                }

                if (visitsElement) {
                    visitsElement.textContent = formatNumber(data.visits || 0);
                }

                if (visitorsElement) {
                    visitorsElement.textContent = formatNumber(data.visitors || 0);
                }

            } catch (error) {
                console.error('获取文章统计数据失败:', error);
                const elements = ['post-pageviews', 'post-visits', 'post-visitors'];
                elements.forEach(id => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.textContent = '获取失败';
                        element.classList.add('text-red-500');
                    }
                });
            }
        }

        document.addEventListener('DOMContentLoaded', fetchPostStats);

        if (window.swup) {
            window.swup.hooks.on('page:view', fetchPostStats);
        }
    </script>
)}